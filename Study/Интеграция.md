# –ü—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥

PostgreSQL —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç "–Ω–∞ –ª–µ—Ç—É" –ø–æ—Ç–æ–∫ **–∏–∑–º–µ–Ω–µ–Ω–∏–π** –ø–æ –æ–±—ã—á–Ω–æ–º—É `SELECT`.   
–û–¥–Ω–∞–∫–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–ø—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫–æ–≤—É—é** –∏–ª–∏ **—Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç–æ–∫–æ–≤—É—é —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é** –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: **–ü—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫** ‚Äî "—á—Ç–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"

> üîß –ü—Ä–æ—Å—Ç–æ, –Ω–æ –Ω–µ ¬´—Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫¬ª. –ü–æ–¥—Ö–æ–¥–∏—Ç –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞.

–ò–¥–µ—è: —Ç—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥, –º–∏–Ω—É—Ç—É –∏ —Ç.–ø.) –≤—ã–ø–æ–ª–Ω—è–µ—à—å:

1. `SELECT * FROM table WHERE id > last_max_id`
2. –≤—Å—Ç–∞–≤–ª—è–µ—à—å —ç—Ç–æ –≤ ClickHouse
3. —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å `last_max_id` (–≤ —Ñ–∞–π–ª –∏–ª–∏ –±–∞–∑—É)

üì¶ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ stream-–ø–æ–¥—Ö–æ–¥, –Ω–æ –±–µ–∑ Kafka –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2: **–ü–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ PostgreSQL logical replication + Debezium/Kafka**

> üöÄ –≠—Ç–æ —É–∂–µ "–Ω–∞—Å—Ç–æ—è—â–∏–π" —Å—Ç—Ä–∏–º–∏–Ω–≥.

* PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **logical replication** (–∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ –≤ –≤–∏–¥–µ WAL)
* Debezium –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —ç—Ç–æ –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ **Kafka**
* ClickHouse –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ Kafka-—Å—Ç—Ä–∏–º —á–µ—Ä–µ–∑ **Kafka engine**

**–°—Ö–µ–º–∞:**

```
PostgreSQL ‚Üí Debezium ‚Üí Kafka ‚Üí ClickHouse Kafka engine ‚Üí MergeTree
```

üìå –°–ª–æ–∂–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–æ–ª—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 3: **PostgreSQL LISTEN/NOTIFY + Python** (—Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π polling)

> –ù–∏–∑–∫–∏–π overhead, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ

* PostgreSQL –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–∏–≥–Ω–∞–ª—ã —á–µ—Ä–µ–∑ `NOTIFY`
* Python —Å `asyncpg` –∏–ª–∏ `psycopg2` –º–æ–∂–µ—Ç —Å–ª—É—à–∞—Ç—å –∏—Ö
* –ü–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞ —Ç—ã –∑–∞–±–∏—Ä–∞–µ—à—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ—à—å

---

## üîß –®–∞–±–ª–æ–Ω "–ø—Å–µ–≤–¥–æ—Å—Ç—Ä–∏–º–µ—Ä–∞** (–≤–∞—Ä–∏–∞–Ω—Ç 1):

```python
import time
import psycopg2
import clickhouse_connect

last_id = 0
BATCH_SIZE = 1000
SLEEP_TIME = 10  # —Å–µ–∫—É–Ω–¥

pg_conn = psycopg2.connect(...)
pg_cursor = pg_conn.cursor()
ch_client = clickhouse_connect.get_client(...)

while True:
    pg_cursor.execute("SELECT id, name, value FROM source_table WHERE id > %s ORDER BY id ASC LIMIT %s", (last_id, BATCH_SIZE))
    rows = pg_cursor.fetchall()

    if rows:
        ch_client.insert('target_table', data=rows, column_names=['id', 'name', 'value'])
        last_id = rows[-1][0]
        print(f"üü¢ –í—Å—Ç–∞–≤–ª–µ–Ω–æ {len(rows)} —Å—Ç—Ä–æ–∫, last_id = {last_id}")
    else:
        print("‚è≥ –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö")

    time.sleep(SLEEP_TIME)
```

---

## üìå –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `LISTEN / NOTIFY`

* –í PostgreSQL —Ç—ã –º–æ–∂–µ—à—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

  ```sql
  NOTIFY my_channel, 'new_data_ready';
  ```
* –ê —Å–µ—Å—Å–∏—è, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–¥–ø–∏—Å–∞–Ω–∞ –Ω–∞ `LISTEN my_channel`, –ø–æ–ª—É—á–∏—Ç —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.
* –í Python —Ç—ã –º–æ–∂–µ—à—å —Å–ª—É—à–∞—Ç—å —Ç–∞–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ `psycopg2`.

---

## ‚úÖ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ ETL-—Å—Ü–µ–Ω–∞—Ä–∏–∏

### üî∏ 1. –í PostgreSQL: —Å–æ–∑–¥–∞—ë–º —Ç—Ä–∏–≥–≥–µ—Ä

```sql
-- –ö–∞–Ω–∞–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–∏–≥–Ω–∞–ª
-- (–∏–º—è –ª—é–±–æ–µ: 'data_ready', 'etl_triggered' –∏ —Ç.–ø.)

CREATE OR REPLACE FUNCTION notify_new_data()
RETURNS trigger AS $$
BEGIN
    PERFORM pg_notify('new_data', NEW.id::text);  -- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å ID
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –í–µ—à–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ –Ω—É–∂–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
CREATE TRIGGER data_inserted
AFTER INSERT ON source_table
FOR EACH ROW EXECUTE FUNCTION notify_new_data();
```

---

### üî∏ 2. –í Python: —Å–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è

```python
import psycopg2
import select

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
conn = psycopg2.connect(
    host='localhost',
    port=5432,
    database='source_db',
    user='pg_user',
    password='pg_pass'
)
conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)
cur = conn.cursor()

# –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
cur.execute("LISTEN new_data;")
print("üîî –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª 'new_data'...")

while True:
    # –ñ–¥—ë–º —Å–æ–±—ã—Ç–∏–µ (–±–ª–æ–∫–∏—Ä—É—é—â–∏–π –≤—ã–∑–æ–≤ –Ω–∞ select.select)
    if select.select([conn], [], [], 60) == ([], [], []):
        print("‚è≥ –ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ç–∞–π–º–∞—É—Ç 60 —Å–µ–∫)...")
    else:
        conn.poll()
        while conn.notifies:
            notify = conn.notifies.pop(0)
            print(f"üì¨ –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {notify.payload}")

            # –ú–æ–∂–Ω–æ —Ç—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å SELECT/INSERT ‚Üí ClickHouse
```

---

## üß† –ö—É–¥–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ

| –°—Ü–µ–Ω–∞—Ä–∏–π                                     | –ü–æ–¥—Ö–æ–¥–∏—Ç?               |
| -------------------------------------------- | ----------------------- |
| –†–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—Å—Ç–∞–≤–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É             | ‚úÖ –û—Ç–ª–∏—á–Ω–æ               |
| –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å near-realtime ETL                | ‚úÖ –î–∞                    |
| –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å payload (ID, –¥–∞—Ç—É –∏ —Ç.–ø.)         | ‚úÖ –ú–æ–∂–Ω–æ                 |
| –ú–∞—Å—Å–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è / —Å—Ç—Ä–∏–º–∏–Ω–≥ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ | ‚ùå –ù–µ—Ç ‚Äî –ª—É—á—à–µ Kafka/CDC |

---

## üß© –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ —Ç–≤–æ—ë–º —Å–ª—É—á–∞–µ

–¢—ã –º–æ–∂–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫:

1. PostgreSQL –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `NOTIFY` –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫.
2. Python-—Å–∫—Ä–∏–ø—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –∏:

   * –¥–µ–ª–∞–µ—Ç `SELECT WHERE id > last_id`
   * –ø–µ—Ä–µ–ª–∏–≤–∞–µ—Ç –≤ ClickHouse
   * –æ–±–Ω–æ–≤–ª—è–µ—Ç last\_id

