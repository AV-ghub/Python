# –ü—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥

PostgreSQL —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç "–Ω–∞ –ª–µ—Ç—É" –ø–æ—Ç–æ–∫ **–∏–∑–º–µ–Ω–µ–Ω–∏–π** –ø–æ –æ–±—ã—á–Ω–æ–º—É `SELECT`.   
–û–¥–Ω–∞–∫–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–ø—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫–æ–≤—É—é** –∏–ª–∏ **—Ä–µ–∞–ª—å–Ω–æ –ø–æ—Ç–æ–∫–æ–≤—É—é —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é** –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: **–ü—Å–µ–≤–¥–æ–ø–æ—Ç–æ–∫** ‚Äî "—á—Ç–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"

> üîß –ü—Ä–æ—Å—Ç–æ, –Ω–æ –Ω–µ ¬´—Ä–µ–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫¬ª. –ü–æ–¥—Ö–æ–¥–∏—Ç –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞.

–ò–¥–µ—è: —Ç—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥, –º–∏–Ω—É—Ç—É –∏ —Ç.–ø.) –≤—ã–ø–æ–ª–Ω—è–µ—à—å:

1. `SELECT * FROM table WHERE id > last_max_id`
2. –≤—Å—Ç–∞–≤–ª—è–µ—à—å —ç—Ç–æ –≤ ClickHouse
3. —Å–æ—Ö—Ä–∞–Ω—è–µ—à—å `last_max_id` (–≤ —Ñ–∞–π–ª –∏–ª–∏ –±–∞–∑—É)

üì¶ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ stream-–ø–æ–¥—Ö–æ–¥, –Ω–æ –±–µ–∑ Kafka –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2: **–ü–æ—Ç–æ–∫ —á–µ—Ä–µ–∑ PostgreSQL logical replication + Debezium/Kafka**

> üöÄ –≠—Ç–æ —É–∂–µ "–Ω–∞—Å—Ç–æ—è—â–∏–π" —Å—Ç—Ä–∏–º–∏–Ω–≥.

* PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **logical replication** (–∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ –≤ –≤–∏–¥–µ WAL)
* Debezium –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —ç—Ç–æ –∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ **Kafka**
* ClickHouse –º–æ–∂–µ—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ Kafka-—Å—Ç—Ä–∏–º —á–µ—Ä–µ–∑ **Kafka engine**

**–°—Ö–µ–º–∞:**

```
PostgreSQL ‚Üí Debezium ‚Üí Kafka ‚Üí ClickHouse Kafka engine ‚Üí MergeTree
```

üìå –°–ª–æ–∂–Ω–æ, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–æ–ª—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---

## ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 3: **PostgreSQL LISTEN/NOTIFY + Python** (—Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π polling)

> –ù–∏–∑–∫–∏–π overhead, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ

* PostgreSQL –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–∏–≥–Ω–∞–ª—ã —á–µ—Ä–µ–∑ `NOTIFY`
* Python —Å `asyncpg` –∏–ª–∏ `psycopg2` –º–æ–∂–µ—Ç —Å–ª—É—à–∞—Ç—å –∏—Ö
* –ü–æ—Å–ª–µ —Å–∏–≥–Ω–∞–ª–∞ —Ç—ã –∑–∞–±–∏—Ä–∞–µ—à—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ—à—å

---

## üîß –®–∞–±–ª–æ–Ω "–ø—Å–µ–≤–¥–æ—Å—Ç—Ä–∏–º–µ—Ä–∞** (–≤–∞—Ä–∏–∞–Ω—Ç 1):

```python
import time
import psycopg2
import clickhouse_connect

last_id = 0
BATCH_SIZE = 1000
SLEEP_TIME = 10  # —Å–µ–∫—É–Ω–¥

pg_conn = psycopg2.connect(...)
pg_cursor = pg_conn.cursor()
ch_client = clickhouse_connect.get_client(...)

while True:
    pg_cursor.execute("SELECT id, name, value FROM source_table WHERE id > %s ORDER BY id ASC LIMIT %s", (last_id, BATCH_SIZE))
    rows = pg_cursor.fetchall()

    if rows:
        ch_client.insert('target_table', data=rows, column_names=['id', 'name', 'value'])
        last_id = rows[-1][0]
        print(f"üü¢ –í—Å—Ç–∞–≤–ª–µ–Ω–æ {len(rows)} —Å—Ç—Ä–æ–∫, last_id = {last_id}")
    else:
        print("‚è≥ –ù–µ—Ç –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö")

    time.sleep(SLEEP_TIME)
```

---


